name: CI/CD - DevOps ITLA

# Ejecutar el workflow cuando se haga push a la rama main
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permitir ejecuciÃ³n manual

# Variables de entorno globales
env:
  NTFY_URL: https://ntfy.sh/devops-itla
  NODE_VERSION: '18'

jobs:
  build-test-notify:
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================
      # 1. CHECKOUT DEL CÃ“DIGO
      # ==========================================
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      # ==========================================
      # 2. CONFIGURAR ENTORNO NODE.JS
      # ==========================================
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # ==========================================
      # 3. MOSTRAR INFORMACIÃ“N DEL COMMIT
      # ==========================================
      - name: ğŸ“‹ InformaciÃ³n del commit
        run: |
          echo "================================================"
          echo "INFORMACIÃ“N DEL BUILD"
          echo "================================================"
          echo "ğŸ“¦ Repositorio: ${{ github.repository }}"
          echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ’¬ Mensaje: ${{ github.event.head_commit.message }}"
          echo "ğŸ”– Commit SHA: ${{ github.sha }}"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "================================================"
      
      # ==========================================
      # 4. EJECUTAR PROGRAMA HOLA MUNDO
      # ==========================================
      - name: ğŸš€ Ejecutar programa Hola Mundo
        run: |
          echo "Ejecutando app.js..."
          node app.js
      
      # ==========================================
      # 5. EJECUTAR TESTS BÃSICOS
      # ==========================================
      - name: ğŸ§ª Ejecutar tests bÃ¡sicos
        run: |
          echo "Ejecutando tests..."
          node app.test.js
      
      # ==========================================
      # 6. NOTIFICACIÃ“N DE Ã‰XITO
      # ==========================================
      - name: âœ… Notificar build exitoso
        if: success()
        run: |
          # Preparar el mensaje
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Enviar notificaciÃ³n
          curl -H "Title: âœ… BUILD EXITOSO - DevOps ITLA" \
               -H "Priority: default" \
               -H "Tags: white_check_mark,rocket,tada" \
               -H "Actions: view, Ver Logs, $WORKFLOW_URL, clear=true" \
               -d "ğŸ‰ El build se completÃ³ exitosamente!
          
          ğŸ“¦ Repositorio: ${{ github.repository }}
          ğŸŒ¿ Rama: ${{ github.ref_name }}
          ğŸ‘¤ Autor: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          ğŸ”– SHA: ${{ github.sha }}
          
          âœ… Programa ejecutado correctamente
          ğŸ§ª Todos los tests pasaron
          
          ğŸ”— Ver logs completos: $WORKFLOW_URL" \
               ${{ env.NTFY_URL }}
      
      # ==========================================
      # 7. NOTIFICACIÃ“N DE FALLO
      # ==========================================
      - name: âŒ Notificar build fallido
        if: failure()
        run: |
          # Preparar el mensaje
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Enviar notificaciÃ³n de error
          curl -H "Title: âŒ BUILD FALLIDO - DevOps ITLA" \
               -H "Priority: urgent" \
               -H "Tags: x,warning,rotating_light" \
               -H "Actions: view, Ver Logs, $WORKFLOW_URL, clear=true" \
               -d "âš ï¸ El build ha fallado!
          
          ğŸ“¦ Repositorio: ${{ github.repository }}
          ğŸŒ¿ Rama: ${{ github.ref_name }}
          ğŸ‘¤ Autor: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          ğŸ”– SHA: ${{ github.sha }}
          
          âŒ Por favor revisar los logs del workflow
          
          ğŸ”— Ver logs completos: $WORKFLOW_URL" \
               ${{ env.NTFY_URL }}
      
      # ==========================================
      # 8. RESUMEN DEL BUILD
      # ==========================================
      - name: ğŸ“Š Resumen del build
        if: always()
        run: |
          echo "================================================"
          echo "RESUMEN DEL BUILD"
          echo "================================================"
          echo "Estado: ${{ job.status }}"
          echo "DuraciÃ³n: ${{ github.event.head_commit.timestamp }}"
          echo "================================================"